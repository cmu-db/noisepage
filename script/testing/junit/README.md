# JUnit Integration Tests

This directory contains system integration tests implemented in Java with JUnit5.

### Overview

This directory contains the implementation for two sets of automated integration tests:

- Tracefile Tests: These tests consist of two components:
  - Trace Files: These files may be either manually or automatically generated. They contain queries along with expected results and are interpreted by the test runner program `TracefileTest.java`.
  - Test Runner: The program `TracefileTest.java` contains the logic required to interpret a trace file and run it against the DBMS server.
- Non-Tracefile Tests: These tests are implemented directly via Java programs that interact with the DBMS server.

### Contents

The top-level contents of this directory are as follows:

- `lib/`: Contains packaged libraries (Java JAR files) that we utilize in this testing infrastructure.
- `sql/`: Contains the raw SQL files used to generate trace files for tracefile integration tests.
- `src/`: Contains the source code for the automated testing infrastructure itself, as well as various utility programs that support writing new tests.
- `traces/`: Contains the trace files used in the tracefile integration tests. These trace files are generated by the `GenerateTrace.java` program (in `src/`) from the SQL files in the `sql/` directory.

A further breakdown of the contents of the `src/` directory:

- The `moglib` directory contains modified APIs from Wan's mogjdbc library; we use this to handle some aspects of database interaction.
- `GenerateTrace.java` is a utility that converts an input file consisting of SQL statements to the trace file format used in tracefile integration tests (see below).
- `TracefileTest.java` takes in path to a trace file from an environment variable (`NOISEPAGE_TRACE_FILE`) and dynamically generates a test case for each query. 
- `TrafficCopTest.java` and `WireTest.java` are non-tracefile integration tests.
- `TestUtility.java` provides a list of utility methods; it contains supporting functions shared across tests.

### Usage: `TracefileTest.java`

`TracefileTest.java` implements automatic tracefile integration tests. Each test case executed by the program consists of (roughly) the following steps:

1. Execute the query
2. Get the result from database
3. Check if the hash/result/len match
4. If a non-select query failed and the error code is provided in the trace, the codes will be compared

### Usage: `FilterTrace.java`

The following section describes usage of the `FilterTrace.java` program.

**Procedure**

The procedure for running the `FilterTrace.java` program is as follows:

1. Establish a local Postgres database and start the database server. The procedure to accomplish this depends on the particulars of your development environment. If you are using a CMU DB development machine, see the _PostgreSQL on CMU DB Development Machines_ section below.
2. Prepare your input trace file
3. Compile the test infrastructure: `ant compile`
4. Run the filter trace program: `ant filter-trace`. The program expects 6 arguments:
  - `path`: The path to the input file
  - `db-url`: The JDBC URL for the DBMS server
  - `db-user`: The database username
  - `db-password`: The database password
  - `skip-list`: The list of target terms to skip
  - `output-name`: The name of the output file

The complete format for the command looks like:

```bash
ant filter-trace -Dpath=INPUT_FILE_PATH -Ddb-url=JDBC_URL -Ddb-user=DB_USERNAME -Ddb-password=DB_PASSWORD -Dskip-list=DESIRED_SKIP_LIST -Doutput-name=OUTPUT_FILENAME
```

Upon running this command, an output trace file should be produced called `mytrace_new` (where `mytrace` is the name of the input tracefile. The simply rename `mytrace_name.txt` to contain `mytrace_new.test` for it to be included in 
future JUnit test runs.

**Example**

Suppose we want to run `FilterTrace.java` with the following configuration:

- SQL Input File: `select.test` (located in the `traces/` directory)
- JDBC URL: `jdbc:postgresql://localhost/mydb`
- Database Username: `admin`
- Database Password: `password`
- Skip List: [CASE,BETWEEN,WHERE,abs(,WHEN]
- Output Name: `select_new.test`

The corresponding command would be:

```bash
ant filter-trace -Dpath=traces/select.test -Ddb-url=jdbc:postgresql://localhost/mydb -Ddb-user=admin -Dpassword=password -Dskip-list="CASE,BETWEEN,WHERE,abs(,WHEN" -Doutput-name=select_new.test
```

The output file contains all traces as before, except that for any query that contains any keyword within the `skip-list`, a "skip" tag is added above the query so that when
`TracefileTest.java` is run the query is ignored. For a query that doesn't contain any keyword within the `skip-list`, its hash is updated with the reference result from Postgres.

### Usage: `GenerateTrace.java`

The following section describes usage of the `GenerateTrace.java` program.

**Procedure**

The procedure for running the `GenerateTrace.java` program is as follows:

1. Establish a local Postgres database and start the database server. The procedure to accomplish this depends on the particulars of your development environment. If you are using a CMU DB development machine, see the _PostgreSQL on CMU DB Development Machines_ section below.
2. Write your own SQL input file. The format of this file consists of SQL statements, one per line. Comments (denoted by `#`)) are permitted. 
3. Compile the test infrastructure: `ant compile`
4. Run the filter trace program: `ant filter-trace`. The program expects 6 arguments:
  - `path`: The path to the input file
  - `db-url`: The JDBC URL for the DBMS server
  - `db-user`: The database username
  - `db-password`: The database password
  - `output-name`: The name of the output file

The complete format for the command looks like:

```bash
ant generate-trace -Dpath=INPUT_PATH -Ddb-url=JDBC_URL -Ddb-user=DB_USERNAME -Ddb-password=DB_PASSWORD -Doutput-name=OUTPUT_FILENAME
```

Upon running the above commnd, an output file should be produced which is in the traceile format. Provided the extension for the output file is `.test` (e.g. `select.test`) it will be included in future automated tracefile test invocations.

**Example** 

Suppose we want to run `GenerateTrace.java` with the following configuration:

- SQL Input File: `select.test` (located in the `traces/` directory)
- JDBC URL: `jdbc:postgresql://localhost/mydb`
- Database Username: `admin`
- Database Password: `password`
- Output Name: `select_new.test`

The corresponding command would be:

```bash
ant generate-trace -Dpath=sql/select.sql -Ddb-url=jdbc:postgresql://localhost/mydb -Ddb-user=admin -Ddb-password=password -Doutput-name=select.test
```

**Additional Details**

- Comments are supported for input files (line starting with `#`)
- Include `Fail` in comment if you expect the query to fail
- Use the format `Num of outputs` to specify the expected number of outputs; if a number is specified, then in the test runner (`TracefileTest.java`) the size of the result set is checked.
- Use the format `Include Outputs` to specify that you want to store the exact query result instead of its hash value

Example input line for `GenerateTrace.java`: 

```
# Num of outputs: 2
SELECT t1 FROM TableA
```

Then in `TracefileTest.java`, the SQL statement will be executed and in addition to checking if the hash matches, the number of results is checked as well. An exception will be thrown if the expected number of results is not observed.

Example input line for `GenerateTrace.java`:

```
# Include Outputs
SELECT t1 FROM TableA
```

Then in the resulting tracefile, the full output from the query, (e.g. `[1,2,3]`), will be stored instead of the hash.

### System Dependencies and Installation

Running the integration tests requires the following depenenencies:

- Java JDK or JRE (Which versions are supported?)
- `ant` (install with `sudo apt-get update && sudo apt-get install ant`)

The necessary Java libraries supporting these tests are included in the `lib/` directory.

### Running the Tests

The primary use of the automated tests in this directory is for use in the continuous integration pipeline. However, they may also be run manually to, for instance, verify the correct behavior of new top-level functionality.

The `run_junit.py` Python script is provided as a "frontend" for the integration testing infrastructure. To run all integration tests (both tracefile and non-tracefile tests) ensure the NoisePage Python virtual environment is activated, then run:

```bash
PYTHONPATH=.. python -m script.testing.junit
```

It is also possible to run individual tracefile tests, as specified by the test name:

```bash
PYTHONPATH=.. python -m script.testing.junit --tracefile-test select.test
```

Modifying the `PYTHONPATH` environment variable before invoking the script is necessary because we assume the command is being run from the `build/` directory. Depending on the particulars of the environment in which you intend to execute the script this may or may not be necessary.

The script takes care of all of the necessary setup, including compiling the tests, starting the DBMS server, and executing the tests themselves. However, **it is assumed that the NoisePage binary already exists prior to executing the script**.

For a description of the configuration options available, run:

```bash
PYTHONPATH=.. python -m script.testing.junit --help

JUnit runner.

optional arguments:
  -h, --help            show this help message and exit
  --db-host DB_HOST     DB hostname.
  --db-port DB_PORT     DB port.
  --db-output-file DB_OUTPUT_FILE
                        DB output log file.
  --test-output-file TEST_OUTPUT_FILE
                        Test output log file.
  --build-type {debug,release,relwithdebinfo}
                        Build type (default: debug).
  --query-mode {simple,extended}
                        Query protocol mode.
  --prepare-threshold PREPARE_THRESHOLD
                        Threshold under the 'extended' query mode.
  --tracefile-test TRACEFILE_TEST
                        The name of a particular tracefile test to run.
  -a SERVER_ARG, --server-arg SERVER_ARG
                        Server commandline arguments.
```

### Adding New Tests

Adding new tests is straightforward:

- To add a new tracefile test, add the trace file (ensuring the extension is `.test`) to the `junit/traces/` directory.
- To add a non-tracefile test, add the Java source file(s) to the `junit/src/` directory.

Ant compiles all Java files present in the `src/` directory. The test runners automatically find all compiled tests and execute them.

**Code Structure for New Tests**

- See `TrafficCopTest.java` for an example of a non-tracefile integration test. Each test requires a `Connection` variable and SQL statements to setup the tables.
- JUnit invokes the `Setup()` method prior to each test and then calls `Teardown()` after it completes. If you need different granularity, see the JUnit5 documentation. For instance, class level setup and teardown is possible.
- Functions annotated with `@Test` denote the actual tests.

### Code Style

You can check code style for Java source with:

```bash
ant checkstyle
```

This is not integrated into the CI pipeline or as a pre-commit/pre-push hook in any way, but it is nice to know that one can easily verfiy a baseline, uniform style across the Java source for the integration tests in this directory.

### PostgreSQL on CMU DB Development Machines

You can use the procedure below to install and setup PostgreSQL for use with integration tests on a CMU DB development machine.

Install PostgreSQL with `apt`:

```bash
sudo apt-get update && sudo apt-get install postgresql
```

Check the status of running PostgreSQL instances:

```bash
pg_lsclusters
...
12  main    5432 online postgres /var/lib/postgresql/12/main /var/log/postgresql/postgresql-12-main.log
```

On Ubuntu 20.04 at the time of this writing, PostgreSQL 12 is the version installed by `apt`. The above output indicates that the DBMS is running. If this is not the case, we can start it with:

```bash
pg_ctlcluster 12 main start
```

Once the DBMS server is running, we just need to create a database that we can use to generate trace files. For instance, we can create the `test` database as follows:

```bash
$ sudo -u postgres psql
postgres=# CREATE DATABASE test;
postgres=# \l
                                  List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   
-----------+----------+----------+-------------+-------------+-----------------------
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 test      | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
postgres=# CREATE USER admin WITH ENCRYPTED PASSWORD 'password';
postgres=# GRANT ALL PRIVILEGES ON DATABASE test TO admin;
postgres=# exit
```

We can test this setup with `psql`:

```bash
$ psql -h localhost -U admin -d test
Password for user admin: 
psql (12.5 (Ubuntu 12.5-0ubuntu0.20.04.1), server 12.6 (Ubuntu 12.6-0ubuntu0.20.04.1))
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off)
Type "help" for help.

test=> 
```

Now the parameters we specify for `GenerateTrace.java` or `FilterTrace.java` are:

- Database User: `admin`
- Database Password: `password`
- JDBC URL: `jdbc:postgresql://localhost/test`
